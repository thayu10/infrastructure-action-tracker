<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Infrastructure Action Tracker</title>

  <style>
    :root{
      --bg:#08162a;
      --card:#0b2342;
      --line:#1c3f66;
      --text:#e9f2ff;
      --muted:#a9c3e6;
      --accent:#2ea8ff;
      --good:#28d17c;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --radius:14px;
      --radius-lg:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: linear-gradient(180deg,#08162a,#050e1b);
      color:var(--text);
    }

    .wrap{ max-width:1100px; margin:auto; padding:18px; }

    .topbar{
      background:linear-gradient(180deg,#0c2a50,#08162a);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:16px;
      display:flex;
      justify-content:space-between;
      gap:16px;
    }

    h1{ margin:0; font-size:20px; }
    .subtitle{ font-size:13px; color:var(--muted); max-width:720px; }

    .chips{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background:#0c2a50;
      border:1px solid var(--line);
      font-size:12px;
      font-family:var(--mono);
      color:var(--muted);
    }

    .btn{
      background:#0c2a50;
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .btn.primary{ border-color:var(--accent); }
    .btn.good{ border-color:var(--good); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .card{
      margin-top:14px;
      background:linear-gradient(180deg,#0b2342,#08162a);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:14px;
    }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input,select,textarea{
      width:100%;
      background:#061223;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px;
      border-radius:12px;
      font-size:13px;
      outline:none;
    }

    textarea{ min-height:90px; }

    table{ width:100%; border-collapse:collapse; }
    th,td{
      padding:10px;
      border-bottom:1px solid rgba(28,63,102,.85);
      font-size:13px;
      vertical-align:top;
    }
    th{ color:var(--muted); font-size:12px; }

    .pill{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      font-family:var(--mono);
      display:inline-block;
    }
    .p1{ border-color:var(--bad); }
    .p2{ border-color:var(--warn); }
    .p3{ border-color:var(--accent); }

    .open{ border-color:var(--accent); }
    .blocked{ border-color:var(--warn); }
    .resolved{ border-color:var(--good); }
    .closed{ opacity:.6; }

    .link{
      color:var(--accent);
      font-weight:600;
      cursor:pointer;
      margin-right:10px;
      user-select:none;
    }

    .filters{
      display:grid;
      grid-template-columns:1.3fr repeat(4,1fr) auto;
      gap:10px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:20;
    }

    .modal{
      background:linear-gradient(180deg,#0b2342,#08162a);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      width:min(900px,100%);
      max-height:90vh;
      overflow:auto;
      padding:16px;
    }

    .modal h2{ margin:0; font-size:16px; }

    .modal-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .full{ grid-column:1/-1; }

    .sep{
      height:1px;
      background:rgba(28,63,102,.85);
      margin:12px 0;
    }

    .footer{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .evidence-box{
      border:1px solid rgba(28,63,102,.85);
      background:rgba(6,18,35,.35);
      border-radius:14px;
      padding:12px;
    }
    .evidence-list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      color:var(--muted);
      font-size:12.5px;
    }
    .evidence-list li{
      padding:8px 8px;
      border-bottom:1px solid rgba(28,63,102,.55);
    }
    .evidence-list code{
      font-family:var(--mono);
      font-size:12px;
      color:#d7efff;
    }

    .toast{
      position:fixed;
      bottom:16px; right:16px;
      background:#0b2342;
      border:1px solid var(--line);
      padding:12px;
      border-radius:14px;
      display:none;
      z-index:30;
      font-size:13px;
      max-width:420px;
      line-height:1.35;
    }
    .toast small{ display:block; margin-top:6px; color:var(--muted); font-family:var(--mono); }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <h1>Infrastructure Action Tracker</h1>
      <div class="subtitle">
        Lightweight operational tracker for infrastructure actions that 
        captures context, ownership, lifecycle state, and supporting 
        evidence stored in S3.
      </div>
      <div class="chips">
        <span class="chip" id="chip-user"></span>
        <span class="chip" id="chip-role"></span>
      </div>
    </div>
    <div>
      <button class="btn primary" id="btn-new">New Action</button>
      <button class="btn" id="btn-refresh">Refresh</button>
    </div>
  </div>

  <div class="card">
    <div class="filters">
      <div>
        <label>Search</label>
        <input id="q" placeholder="Type to filter (Enter optional)"/>
      </div>
      <div><label>Status</label><select id="f-status"></select></div>
      <div><label>Priority</label><select id="f-priority"></select></div>
      <div><label>Owner</label><select id="f-owner"></select></div>
      <div><label>Component</label><select id="f-component"></select></div>
      <button class="btn" id="btn-clear">Clear</button>
    </div>
    <div class="hint">Filtering updates automatically as you type. Press Enter if you prefer an explicit apply action</div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Priority</th><th>Status</th><th>Title</th>
          <th>Owner</th><th>Component</th><th>Updated</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="7" style="color:var(--muted)">Loading…</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- Modal -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <h2 id="modal-title">New Action</h2>

    <div class="modal-grid">
      <div class="full">
        <label>Title</label>
        <input id="m-title"/>
      </div>

      <div><label>Priority</label><select id="m-priority"></select></div>
      <div><label>Owner</label><select id="m-owner"></select></div>
      <div class="full"><label>Component</label><select id="m-component"></select></div>

      <div class="full">
        <label>Description</label>
        <textarea id="m-description"></textarea>
      </div>

      <div class="full">
        <label>Status</label>
        <select id="m-status"></select>
      </div>

      <div class="full">
        <div class="sep"></div>
        <label>Evidence</label>
        <div class="evidence-box">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <input type="file" id="m-file" />
            <button class="btn good" id="btn-upload">Upload</button>
            <span class="chip" id="chip-actionid">Action ID: (save first)</span>
          </div>
          <div class="hint" style="margin-top:10px;">
            Save the action once. Then upload evidence files (stored in S3 and linked to the action).
          </div>
          <ul class="evidence-list" id="evidence-list">
            <li style="border-bottom:none; padding:6px 0;">No evidence uploaded yet.</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="footer">
      <button class="btn" id="btn-done">Done</button>
      <button class="btn good" id="btn-save">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const CONFIG={
    owners:["thayu10","devops","platform","oncall"],
    components:["ECS-Service","ALB","RDS-Postgres","CI/CD","IAM","S3","VPC","CloudWatch"],
    priorities:["P1","P2","P3"],
    statuses:["Open","In Progress","Blocked","Resolved","Closed"]
  };

  let cache=[];
  let currentActionId=null;
  let editMode=false;

  // You can still override these via headers in curl/postman.
  // In browser, we keep them stable.
  const X_USER = localStorage.getItem("iat_x_user") || "thayu10";
  const X_ROLE = localStorage.getItem("iat_x_role") || "admin";
  localStorage.setItem("iat_x_user", X_USER);
  localStorage.setItem("iat_x_role", X_ROLE);

  document.getElementById("chip-user").textContent=`X-User: ${X_USER}`;
  document.getElementById("chip-role").textContent=`X-Role: ${X_ROLE}`;

  function fillSelect(id, items, anyLabel){
    const s=document.getElementById(id); s.innerHTML="";
    if(anyLabel){
      const o=document.createElement("option");
      o.value="";
      o.textContent=anyLabel;
      s.appendChild(o);
    }
    items.forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      s.appendChild(o);
    });
  }

  fillSelect("f-status", CONFIG.statuses, "Any status");
  fillSelect("f-priority", CONFIG.priorities, "Any priority");
  fillSelect("f-owner", CONFIG.owners, "Any owner");
  fillSelect("f-component", CONFIG.components, "Any component");

  fillSelect("m-priority", CONFIG.priorities);
  fillSelect("m-owner", CONFIG.owners);
  fillSelect("m-component", CONFIG.components);
  fillSelect("m-status", CONFIG.statuses);

  // Defaults
  document.getElementById("m-priority").value="P2";
  document.getElementById("m-owner").value=CONFIG.owners[0];
  document.getElementById("m-component").value=CONFIG.components[0];
  document.getElementById("m-status").value="Open";

  async function api(path, options={}){
    const headers = {
      "Content-Type":"application/json",
      "X-User": X_USER,
      "X-Role": X_ROLE,
      ...(options.headers || {})
    };
    const res = await fetch(path, { ...options, headers });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch(e) {}
    if(!res.ok){
      throw new Error(data ? JSON.stringify(data) : text);
    }
    return data;
  }

  function toast(msg, meta){
    const el=document.getElementById("toast");
    el.innerHTML = `${escapeHtml(msg)}${meta ? `<small>${escapeHtml(meta)}</small>` : ""}`;
    el.style.display="block";
    clearTimeout(window.__t);
    window.__t=setTimeout(()=>el.style.display="none", 4200);
  }

  function escapeHtml(s){
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function fmtDate(iso){
    try { return new Date(iso).toLocaleString(); }
    catch(e){ return iso || ""; }
  }

  function pillPriority(p){
    const cls = (p || "").toLowerCase();
    return `<span class="pill ${cls}">${escapeHtml(p)}</span>`;
  }

  function pillStatus(s){
    const t=(s||"").toLowerCase();
    const cls = t.includes("blocked") ? "blocked"
      : t.includes("resolved") ? "resolved"
      : t.includes("closed") ? "closed"
      : "open";
    return `<span class="pill ${cls}">${escapeHtml(s)}</span>`;
  }

  function filters(){
    return {
      q: (document.getElementById("q").value || "").toLowerCase().trim(),
      status: document.getElementById("f-status").value,
      priority: document.getElementById("f-priority").value,
      owner: document.getElementById("f-owner").value,
      component: document.getElementById("f-component").value
    };
  }

  function applyFilters(items){
    const f=filters();
    return items.filter(i=>{
      if(f.status && i.status !== f.status) return false;
      if(f.priority && i.priority !== f.priority) return false;
      if(f.owner && i.owner !== f.owner) return false;
      if(f.component && i.component !== f.component) return false;
      if(f.q){
        const hay = `${i.title || ""} ${i.description || ""}`.toLowerCase();
        if(!hay.includes(f.q)) return false;
      }
      return true;
    });
  }

  function render(){
    const rows=document.getElementById("rows");
    const items=applyFilters(cache);

    if(!items.length){
      rows.innerHTML = `<tr><td colspan="7" style="color:var(--muted)">No actions found.</td></tr>`;
      return;
    }

    rows.innerHTML = items.map(i=>`
      <tr>
        <td>${pillPriority(i.priority)}</td>
        <td>${pillStatus(i.status)}</td>
        <td>
          <div style="font-weight:700">${escapeHtml(i.title)}</div>
          <div style="color:var(--muted); margin-top:4px; white-space:pre-wrap">${escapeHtml(i.description||"")}</div>
        </td>
        <td>${escapeHtml(i.owner)}</td>
        <td>${escapeHtml(i.component)}</td>
        <td>${escapeHtml(fmtDate(i.updated_at || i.created_at))}</td>
        <td>
          <span class="link" data-edit="${i.id}">Edit</span>
          <span class="link" data-quick="${i.id}" data-status="In Progress">In Progress</span>
          <span class="link" data-quick="${i.id}" data-status="Blocked">Blocked</span>
          <span class="link" data-quick="${i.id}" data-status="Resolved">Resolve</span>
        </td>
      </tr>
    `).join("");

    rows.querySelectorAll("[data-edit]").forEach(el=>{
      el.addEventListener("click", ()=> openEdit(el.dataset.edit));
    });
    rows.querySelectorAll("[data-quick]").forEach(el=>{
      el.addEventListener("click", ()=> quickUpdate(el.dataset.quick, el.dataset.status));
    });
  }

  async function refresh(){
    try{
      const data = await api("/api/actions");
      cache = data.items || [];
      render();
    }catch(e){
      toast("Failed to load actions", e.message);
      cache = [];
      render();
    }
  }

  async function quickUpdate(id, status){
    try{
      await api(`/api/actions/${id}`, { method:"PATCH", body: JSON.stringify({ status }) });
      toast("Updated", `${id} → ${status}`);
      await refresh();
    }catch(e){
      toast("Update failed", e.message);
    }
  }

  // Modal state helpers
  const backdrop = document.getElementById("backdrop");
  const chipActionId = document.getElementById("chip-actionid");
  const evidenceList = document.getElementById("evidence-list");
  const btnSave = document.getElementById("btn-save");

  function setActionId(id){
    currentActionId = id;
    chipActionId.textContent = id ? `Action ID: ${id}` : "Action ID: (save first)";
  }

  function resetModal(){
    editMode = false;
    setActionId(null);
    document.getElementById("modal-title").textContent = "New Action";
    document.getElementById("m-title").value = "";
    document.getElementById("m-description").value = "";
    document.getElementById("m-priority").value = "P2";
    document.getElementById("m-owner").value = CONFIG.owners[0];
    document.getElementById("m-component").value = CONFIG.components[0];
    document.getElementById("m-status").value = "Open";
    document.getElementById("m-file").value = "";

    btnSave.disabled = false;
    btnSave.textContent = "Save";

    evidenceList.innerHTML = `<li style="border-bottom:none; padding:6px 0;">No evidence uploaded yet.</li>`;
  }

  function openModal(){
    backdrop.style.display = "flex";
  }

  function closeModal(){
    backdrop.style.display = "none";
    resetModal();
  }

  function getFormBody(){
    return {
      title: document.getElementById("m-title").value.trim(),
      description: document.getElementById("m-description").value.trim(),
      owner: document.getElementById("m-owner").value,
      component: document.getElementById("m-component").value,
      priority: document.getElementById("m-priority").value,
      status: document.getElementById("m-status").value
    };
  }

  async function saveAction(){
    const body = getFormBody();

    if(!body.title || !body.description || !body.owner || !body.component || !body.priority){
      toast("Missing required fields", "Title, Description, Owner, Component, Priority are required.");
      return;
    }

    try{
      if(editMode && currentActionId){
        await api(`/api/actions/${currentActionId}`, { method:"PATCH", body: JSON.stringify(body) });
        toast("Action updated", currentActionId);
      }else{
        const res = await api("/api/actions", { method:"POST", body: JSON.stringify(body) });
        setActionId(res.id);
        toast("Action created", res.id);
      }

      // Prevent duplicates: disable Save after successful create/update
      btnSave.disabled = true;
      btnSave.textContent = "Saved ✓";

      // If we now have an ID, load evidence list
      if(currentActionId){
        await loadEvidence(currentActionId);
      }

      await refresh();
    }catch(e){
      toast("Save failed", e.message);
    }
  }

  function openEdit(id){
    const a = cache.find(x => x.id === id);
    if(!a) return;

    resetModal();
    editMode = true;
    setActionId(id);
    document.getElementById("modal-title").textContent = "Edit Action";

    document.getElementById("m-title").value = a.title || "";
    document.getElementById("m-description").value = a.description || "";
    document.getElementById("m-owner").value = a.owner || CONFIG.owners[0];
    document.getElementById("m-component").value = a.component || CONFIG.components[0];
    document.getElementById("m-priority").value = a.priority || "P2";
    document.getElementById("m-status").value = a.status || "Open";

    btnSave.disabled = false;
    btnSave.textContent = "Save";

    openModal();
    loadEvidence(id);
  }

  async function loadEvidence(actionId){
    try{
      const res = await api(`/api/actions/${actionId}/evidence`, { method:"GET" });
      const items = res.items || [];
      if(!items.length){
        evidenceList.innerHTML = `<li style="border-bottom:none; padding:6px 0;">No evidence uploaded yet.</li>`;
        return;
      }
      evidenceList.innerHTML = items.map(it => `
        <li>
          <div style="font-weight:700; color:var(--text)">${escapeHtml(it.filename)}</div>
          <div style="margin-top:4px;"><code>${escapeHtml(it.s3_key)}</code></div>
          <div style="margin-top:4px;">by ${escapeHtml(it.created_by)} @ ${escapeHtml(fmtDate(it.created_at))}</div>
        </li>
      `).join("");
    }catch(e){
      toast("Failed to load evidence", e.message);
    }
  }

  function fileToBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const res = String(reader.result || "");
        const parts = res.split(",");
        resolve(parts.length > 1 ? parts[1] : "");
      };
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(file);
    });
  }

  async function uploadEvidence(){
    if(!currentActionId){
      toast("Save first", "You must save the action before uploading evidence.");
      return;
    }

    const input = document.getElementById("m-file");
    const file = (input.files && input.files[0]) ? input.files[0] : null;
    if(!file){
      toast("No file selected", "Choose a file first.");
      return;
    }

    if(file.size > 5 * 1024 * 1024){
      toast("File too large", "Max 5MB for this demo.");
      return;
    }

    try{
      const b64 = await fileToBase64(file);
      await api(`/api/actions/${currentActionId}/evidence`, {
        method:"POST",
        body: JSON.stringify({ filename: file.name, content_base64: b64 })
      });

      toast("Evidence uploaded", file.name);
      input.value = "";
      await loadEvidence(currentActionId);

      // Keep modal open; user clicks Done when finished.
    }catch(e){
      toast("Upload failed", e.message);
    }
  }

  // UI wiring
  document.getElementById("btn-new").addEventListener("click", ()=>{
    resetModal();
    openModal();
  });

  document.getElementById("btn-done").addEventListener("click", closeModal);

  // click outside modal to close
  backdrop.addEventListener("click", (e)=>{
    if(e.target === backdrop) closeModal();
  });

  btnSave.addEventListener("click", saveAction);
  document.getElementById("btn-upload").addEventListener("click", uploadEvidence);

  document.getElementById("btn-refresh").addEventListener("click", refresh);
  document.getElementById("btn-clear").addEventListener("click", ()=>{
    document.getElementById("q").value="";
    document.getElementById("f-status").value="";
    document.getElementById("f-priority").value="";
    document.getElementById("f-owner").value="";
    document.getElementById("f-component").value="";
    render();
  });

  // Live filtering + Enter optional
  ["q","f-status","f-priority","f-owner","f-component"].forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener("input", render);
    el.addEventListener("change", render);
    if(id === "q"){
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); render(); }
      });
    }
  });

  refresh();
</script>
</body>
</html>
