<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Infrastructure Action Tracker</title>

  <style>
    :root{
      --bg:#08162a;
      --card:#0b2342;
      --line:#1c3f66;
      --text:#e9f2ff;
      --muted:#a9c3e6;
      --accent:#2ea8ff;
      --good:#28d17c;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --radius:14px;
      --radius-lg:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: linear-gradient(180deg,#08162a,#050e1b);
      color:var(--text);
    }

    .wrap{ max-width:1100px; margin:auto; padding:18px; }

    .topbar{
      background:linear-gradient(180deg,#0c2a50,#08162a);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:16px;
      display:flex;
      justify-content:space-between;
      gap:16px;
    }

    h1{ margin:0; font-size:20px; }
    .subtitle{ font-size:13px; color:var(--muted); max-width:720px; }

    .chips{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background:#0c2a50;
      border:1px solid var(--line);
      font-size:12px;
      font-family:var(--mono);
      color:var(--muted);
    }

    .btn{
      background:#0c2a50;
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .btn.primary{ border-color:var(--accent); }
    .btn.good{ border-color:var(--good); }
    .btn.danger{ border-color:var(--bad); }

    .card{
      margin-top:14px;
      background:linear-gradient(180deg,#0b2342,#08162a);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:14px;
    }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input,select,textarea{
      width:100%;
      background:#061223;
      border:1px solid var(--line);
      color:var(--text);
      padding:10px;
      border-radius:12px;
      font-size:13px;
    }

    textarea{ min-height:90px; }

    table{ width:100%; border-collapse:collapse; }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:top;
    }
    th{ color:var(--muted); font-size:12px; }

    .pill{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      font-family:var(--mono);
      display:inline-block;
    }
    .p1{ border-color:var(--bad); }
    .p2{ border-color:var(--warn); }
    .p3{ border-color:var(--accent); }

    .open{ border-color:var(--accent); }
    .blocked{ border-color:var(--warn); }
    .resolved{ border-color:var(--good); }
    .closed{ opacity:.6; }

    .link{
      color:var(--accent);
      font-weight:600;
      cursor:pointer;
      margin-right:8px;
    }

    .filters{
      display:grid;
      grid-template-columns:1.3fr repeat(4,1fr) auto;
      gap:10px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:20;
    }

    .modal{
      background:linear-gradient(180deg,#0b2342,#08162a);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      width:min(900px,100%);
      max-height:90vh;
      overflow:auto;
      padding:16px;
    }

    .modal h2{ margin:0; font-size:16px; }

    .modal-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .full{ grid-column:1/-1; }

    .footer{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .toast{
      position:fixed;
      bottom:16px; right:16px;
      background:#0b2342;
      border:1px solid var(--line);
      padding:12px;
      border-radius:14px;
      display:none;
      z-index:30;
      font-size:13px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <h1>Infrastructure Action Tracker</h1>
      <div class="subtitle">
        Lightweight operational tracker for infrastructure actions — capture context,
        ownership, lifecycle state, and attach evidence stored in S3 with an auditable
        record in Postgres (RDS).
      </div>
      <div class="chips">
        <span class="chip" id="chip-user"></span>
        <span class="chip" id="chip-role"></span>
      </div>
    </div>
    <div>
      <button class="btn primary" id="btn-new">New Action</button>
      <button class="btn" id="btn-refresh">Refresh</button>
    </div>
  </div>

  <div class="card">
    <div class="filters">
      <div>
        <label>Search</label>
        <input id="q" placeholder="Type to filter (Enter optional)"/>
      </div>
      <div><label>Status</label><select id="f-status"></select></div>
      <div><label>Priority</label><select id="f-priority"></select></div>
      <div><label>Owner</label><select id="f-owner"></select></div>
      <div><label>Component</label><select id="f-component"></select></div>
      <button class="btn" id="btn-clear">Clear</button>
    </div>
    <div class="hint">Filtering is live — press Enter or use Search if preferred.</div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Priority</th><th>Status</th><th>Title</th>
          <th>Owner</th><th>Component</th><th>Updated</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="7" style="color:var(--muted)">Loading…</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- Modal -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <h2 id="modal-title">New Action</h2>

    <div class="modal-grid">
      <div class="full">
        <label>Title</label>
        <input id="m-title"/>
      </div>

      <div><label>Priority</label><select id="m-priority"></select></div>
      <div><label>Owner</label><select id="m-owner"></select></div>
      <div class="full"><label>Component</label><select id="m-component"></select></div>

      <div class="full">
        <label>Description</label>
        <textarea id="m-description"></textarea>
      </div>

      <div class="full">
        <label>Status</label>
        <select id="m-status"></select>
      </div>
    </div>

    <div class="footer">
      <button class="btn" id="btn-close">Close</button>
      <button class="btn good" id="btn-save">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* JS trimmed explanation:
   - Create vs Edit mode handled by currentActionId
   - Save disabled after create/update
   - Modal reset on close
   - Edit button added in rows
*/

const CONFIG={
  owners:["thayu10","devops","platform","oncall"],
  components:["ECS-Service","ALB","RDS-Postgres","CI/CD","IAM","S3","VPC","CloudWatch"],
  priorities:["P1","P2","P3"],
  statuses:["Open","In Progress","Blocked","Resolved","Closed"]
};

let currentActionId=null;
let editMode=false;
let cache=[];

const X_USER="thayu10";
const X_ROLE="admin";
document.getElementById("chip-user").textContent=`X-User: ${X_USER}`;
document.getElementById("chip-role").textContent=`X-Role: ${X_ROLE}`;

function fill(id,items,any){
  const s=document.getElementById(id); s.innerHTML="";
  if(any){ const o=document.createElement("option"); o.value=""; o.textContent=any; s.appendChild(o); }
  items.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; s.appendChild(o); });
}

fill("f-status",CONFIG.statuses,"Any status");
fill("f-priority",CONFIG.priorities,"Any priority");
fill("f-owner",CONFIG.owners,"Any owner");
fill("f-component",CONFIG.components,"Any component");

fill("m-priority",CONFIG.priorities);
fill("m-owner",CONFIG.owners);
fill("m-component",CONFIG.components);
fill("m-status",CONFIG.statuses);

async function api(p,o={}){
  const r=await fetch(p,{...o,headers:{...o.headers,"Content-Type":"application/json","X-User":X_USER,"X-Role":X_ROLE}});
  const t=await r.text(); const j=t?JSON.parse(t):null;
  if(!r.ok) throw new Error(t);
  return j;
}

function render(){
  const rows=document.getElementById("rows");
  const q=document.getElementById("q").value.toLowerCase();
  const f=(id)=>document.getElementById(id).value;
  const items=cache.filter(i=>
    (!f("f-status")||i.status===f("f-status")) &&
    (!f("f-priority")||i.priority===f("f-priority")) &&
    (!f("f-owner")||i.owner===f("f-owner")) &&
    (!f("f-component")||i.component===f("f-component")) &&
    (!q||(`${i.title} ${i.description}`).toLowerCase().includes(q))
  );

  rows.innerHTML=items.length?items.map(i=>`
    <tr>
      <td><span class="pill ${i.priority.toLowerCase()}">${i.priority}</span></td>
      <td><span class="pill ${i.status.toLowerCase().replace(" ","")}">${i.status}</span></td>
      <td><strong>${i.title}</strong><br/><small>${i.description}</small></td>
      <td>${i.owner}</td>
      <td>${i.component}</td>
      <td>${new Date(i.updated_at).toLocaleString()}</td>
      <td>
        <span class="link" onclick="openEdit('${i.id}')">Edit</span>
        <span class="link" onclick="quick('${i.id}','In Progress')">In Progress</span>
        <span class="link" onclick="quick('${i.id}','Blocked')">Blocked</span>
        <span class="link" onclick="quick('${i.id}','Resolved')">Resolve</span>
      </td>
    </tr>
  `).join(""):`<tr><td colspan=7>No actions</td></tr>`;
}

async function refresh(){
  const d=await api("/api/actions");
  cache=d.items||[];
  render();
}

async function quick(id,status){
  await api(`/api/actions/${id}`,{method:"PATCH",body:JSON.stringify({status})});
  refresh();
}

function resetModal(){
  currentActionId=null; editMode=false;
  ["m-title","m-description"].forEach(i=>document.getElementById(i).value="");
  document.getElementById("btn-save").disabled=false;
}

function openEdit(id){
  const a=cache.find(x=>x.id===id);
  if(!a)return;
  editMode=true; currentActionId=id;
  document.getElementById("modal-title").textContent="Edit Action";
  ["title","description","owner","component","priority","status"].forEach(f=>{
    document.getElementById("m-"+f).value=a[f];
  });
  openModal();
}

function openModal(){
  document.getElementById("backdrop").style.display="flex";
}
function closeModal(){
  document.getElementById("backdrop").style.display="none";
  resetModal();
}

document.getElementById("btn-new").onclick=()=>{ document.getElementById("modal-title").textContent="New Action"; openModal(); };
document.getElementById("btn-close").onclick=closeModal;

document.getElementById("btn-save").onclick=async()=>{
  const body={
    title:m("title"),description:m("description"),
    owner:m("owner"),component:m("component"),
    priority:m("priority"),status:m("status")
  };
  if(editMode){
    await api(`/api/actions/${currentActionId}`,{method:"PATCH",body:JSON.stringify(body)});
  }else{
    const r=await api("/api/actions",{method:"POST",body:JSON.stringify(body)});
    currentActionId=r.id;
  }
  document.getElementById("btn-save").disabled=true;
  closeModal();
  refresh();
};

function m(x){ return document.getElementById("m-"+x).value; }

document.getElementById("btn-refresh").onclick=refresh;
document.getElementById("btn-clear").onclick=()=>{ ["q","f-status","f-priority","f-owner","f-component"].forEach(i=>document.getElementById(i).value=""); render(); };
["q","f-status","f-priority","f-owner","f-component"].forEach(i=>document.getElementById(i).addEventListener("input",render));

refresh();
</script>
</body>
</html>
