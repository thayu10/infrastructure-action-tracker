name: Manual - Terraform Destroy (dev)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: Type DESTROY to confirm infrastructure destroy
        required: true
        default: ""

permissions:
  contents: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  AWS_REGION: "ap-southeast-1"
  AWS_DEFAULT_REGION: "ap-southeast-1"
  AWS_ROLE_ARN: "arn:aws:iam::516646497975:role/github-actions-infrastructure-action-tracker"
  IMAGE_REPO: "thayu10/infrastructure-action-tracker"

jobs:
  destroy_dev:
    name: Terraform destroy (dev)
    runs-on: ubuntu-latest

    steps:
      - name: Guardrail confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "DESTROY" ]; then
            echo "Confirmation failed. You must type DESTROY."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Terraform init
        working-directory: infra
        run: |
          terraform init -reconfigure \
            -backend-config="region=ap-southeast-1"

      - name: Terraform destroy (dev)
        working-directory: infra
        run: |
          terraform destroy -auto-approve \
            -var-file="env/dev.tfvars" \
            -var="docker_image=${IMAGE_REPO}:destroy-placeholder"

      # üîê SAFETY NET ‚Äî THIS IS THE IMPORTANT PART
      - name: Preserve Terraform state on failure
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state-safety-net
          path: |
            infra/*.tfstate*
            infra/.terraform.tfstate.lock.info
          if-no-files-found: ignore
