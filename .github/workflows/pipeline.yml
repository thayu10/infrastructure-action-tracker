name: Pipeline - Build Image + Terraform Apply (dev)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

env:
  TF_IN_AUTOMATION: "true"
  AWS_REGION: "ap-southeast-1"
  AWS_ROLE_ARN: "arn:aws:iam::516646497975:role/github-actions-infrastructure-action-tracker"
  IMAGE_REPO: "thayu10/infrastructure-action-tracker"

jobs:
  build_push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Basic Python syntax check
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Compile main.py
        run: python -m py_compile app/main.py

      - name: Compute image tag
        id: tag
        run: |
          echo "image_tag=sha-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ${{ env.IMAGE_REPO }}:${{ steps.tag.outputs.image_tag }}

  terraform_apply:
    name: Terraform Apply (dev)
    runs-on: ubuntu-latest
    needs: build_push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.6"

      - name: Terraform fmt check
        working-directory: infra
        run: terraform fmt -check -recursive

      - name: Terraform init
        working-directory: infra
        run: terraform init -reconfigure

      - name: Terraform validate
        working-directory: infra
        run: terraform validate

      - name: Terraform plan (dev)
        working-directory: infra
        run: |
          terraform plan \
            -var-file="env/dev.tfvars" \
            -var="docker_image=${IMAGE_REPO}:${{ needs.build_push.outputs.image_tag }}"

      - name: Terraform apply (dev)
        working-directory: infra
        run: |
          terraform apply -auto-approve \
            -var-file="env/dev.tfvars" \
            -var="docker_image=${IMAGE_REPO}:${{ needs.build_push.outputs.image_tag }}"

      - name: Show ALB URL
        working-directory: infra
        run: |
          echo "ALB DNS:"
          terraform output -raw alb_dns_name || true
          echo ""
          echo "Open: http://$(terraform output -raw alb_dns_name || true)/"
